<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Multi-Chat (Streaming)</title>
    <style>
        :root {
            --border-color: #ccc;
            --bg-color: #ffffff;
            --text-color: #000000;
            --light-bg: #f5f5f5;
            --button-bg: #000;
            --button-text: #fff;
            --error-color: #D8000C;
            --tool-color: #00529B;
        }
        body {
            font-family: sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        @media (min-width: 768px) {
            .container {
                flex-direction: row;
            }
        }
        #sidebar {
            flex: 0 0 250px;
            border-right: 1px solid var(--border-color);
            padding: 1em;
            display: flex;
            flex-direction: column;
            background-color: var(--light-bg);
            overflow-y: auto;
        }
        #chat-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
        }
        #chat-list li {
            padding: 0.8em;
            margin-bottom: 0.5em;
            border: 1px solid var(--border-color);
            cursor: pointer;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #chat-list li.active-chat {
            background-color: var(--button-bg);
            color: var(--button-text);
            font-weight: bold;
        }
        #main-chat {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        #chat-log {
            flex-grow: 1;
            padding: 1em;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .message { margin-bottom: 1em; }
        .message.user { font-weight: bold; }
        .message.assistant { color: #333; }
        .message.error { color: var(--error-color); font-weight: bold; }
        .message.tool { color: var(--tool-color); font-style: italic; }
        #input-area { padding: 1em; border-top: 1px solid var(--border-color); }
        button {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            cursor: pointer;
            padding: 0.8em 1.2em;
            border-radius: 4px;
        }
        button:disabled { background-color: #888; }
        textarea {
            width: 100%;
            padding: 0.8em;
            margin: 0.5em 0;
            box-sizing: border-box;
            font-size: 1em;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        .cursor { 
            display: inline-block; 
            width: 10px; 
            background-color: #000; 
            animation: blink 1s step-end infinite; 
        } 
        @keyframes blink { 
            from, to { background-color: transparent; } 
            50% { background-color: #000; } 
        }
    </style>
</head>
<body>
    <div class="container">
        <aside id="sidebar">
            <h2>Chats</h2>
            <button id="new-chat-btn">New Chat</button>
            <hr>
            <ul id="chat-list"></ul>
            <hr>
            <div id="secure-notice" style="padding: 1em; background-color: #eaf7e9; border: 1px solid #a8d5aa; border-radius: 4px; font-size: 0.9em;">
                <p>Your API key is securely managed by the server.</p>
            </div>
        </aside>
        <main id="main-chat">
            <div id="chat-log"><p>Welcome! Select a chat or start a new one.</p></div>
            <div id="input-area">
                <textarea id="message-input" placeholder="Type your message..." rows="3"></textarea>
                <button id="send-btn">Send Message</button>
            </div>
        </main>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var chatLog = document.getElementById('chat-log');
        var messageInput = document.getElementById('message-input');
        var sendBtn = document.getElementById('send-btn');
        var newChatBtn = document.getElementById('new-chat-btn');
        var chatList = document.getElementById('chat-list');
        var appData = { chats: {}, activeChatId: null };
        var CALCULATOR_SYSTEM_PROMPT = 'You have access to a calculator tool. To use it, you must respond with **only** the following format: <calculate>expression</calculate>. For example: <calculate>2 * (3 + 4)</calculate>. The user will see the result of the calculation. Do not add any other text or explanation in the same message when you use the tool. Perform the calculation when the user asks a question that requires a precise mathematical answer.';
        
        function saveData() { 
            if (typeof(Storage) !== "undefined") {
                localStorage.setItem('claudeMultiChatData_Netlify', JSON.stringify(appData)); 
            }
        }
        
        function loadData() { 
            if (typeof(Storage) !== "undefined") {
                var savedChatData = localStorage.getItem('claudeMultiChatData_Netlify'); 
                if (savedChatData) { 
                    appData = JSON.parse(savedChatData); 
                } 
            }
            if (Object.keys(appData.chats).length === 0) { 
                createNewChat(false); 
            } 
            renderChatList(); 
            renderActiveChat(); 
        }
        
        function renderChatList() { 
            chatList.innerHTML = ''; 
            for (var chatId in appData.chats) { 
                var chat = appData.chats[chatId]; 
                var listItem = document.createElement('li'); 
                listItem.textContent = chat.title; 
                listItem.setAttribute('data-chat-id', chatId); 
                if (chatId === appData.activeChatId) { 
                    listItem.classList.add('active-chat'); 
                } 
                chatList.appendChild(listItem); 
            } 
        }
        
        function renderActiveChat() { 
            chatLog.innerHTML = ''; 
            var activeChat = appData.chats[appData.activeChatId]; 
            if (!activeChat) { 
                chatLog.innerHTML = '<p>Select a chat or start a new one.</p>'; 
                messageInput.disabled = true; 
                sendBtn.disabled = true; 
                return; 
            } 
            activeChat.messages.forEach(function(msg) {
                displayMessage(msg.role, msg.content);
            }); 
            messageInput.disabled = false; 
            sendBtn.disabled = false; 
        }
        
        function displayMessage(role, text) { 
            var messageElem = document.createElement('div'); 
            messageElem.classList.add('message', role); 
            var roleDisplay = role.charAt(0).toUpperCase() + role.slice(1); 
            if (role === 'tool') roleDisplay = 'Calculator'; 
            messageElem.textContent = roleDisplay + ': ' + text; 
            chatLog.appendChild(messageElem); 
            chatLog.scrollTop = chatLog.scrollHeight; 
            return messageElem; 
        }
        
        function createNewChat(shouldSave) { 
            if (shouldSave === undefined) shouldSave = true;
            var chatId = Date.now().toString(); 
            appData.chats[chatId] = { id: chatId, title: 'New Chat', messages: [] }; 
            appData.activeChatId = chatId; 
            if (shouldSave) { 
                saveData(); 
                renderChatList(); 
                renderActiveChat(); 
            } 
        }
        
        function switchChat(chatId) { 
            if (chatId === appData.activeChatId) return; 
            appData.activeChatId = chatId; 
            saveData(); 
            renderChatList(); 
            renderActiveChat(); 
        }
        
        function evaluateCalculation(expression) { 
            try { 
                return Function('return ' + expression)(); 
            } catch (error) { 
                return 'Invalid expression: ' + error.message; 
            } 
        }
        
        function getClaudeResponse() {
            var activeChat = appData.chats[appData.activeChatId];
            var userMessage = messageInput.value.trim();
            if (!userMessage || !activeChat) return;
            
            displayMessage('user', userMessage);
            activeChat.messages.push({ role: 'user', content: userMessage });
            messageInput.value = '';
            
            if (activeChat.messages.length === 1) {
                activeChat.title = userMessage.substring(0, 30) + (userMessage.length > 30 ? '...' : '');
                renderChatList();
            }

            sendBtn.disabled = true;
            sendBtn.textContent = 'Claude is generating...';
            
            var apiUrl = '/.netlify/edge-functions/claude-proxy';
            var assistantMessageElem = displayMessage('assistant', '');
            assistantMessageElem.innerHTML = "Assistant: <span class='cursor'></span>";
            var fullResponse = '';
            
            fetch(apiUrl, {
                method: 'POST',
                headers: { 'content-type': 'application/json' },
                body: JSON.stringify({
                    system: CALCULATOR_SYSTEM_PROMPT,
                    messages: activeChat.messages
                })
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('API Error: ' + response.status);
                }
                return response.body.getReader();
            })
            .then(function(reader) {
                var decoder = new TextDecoder();
                
                function readChunk() {
                    return reader.read().then(function(result) {
                        if (result.done) {
                            return;
                        }
                        
                        var chunk = decoder.decode(result.value, { stream: true });
                        var lines = chunk.split('\n');
                        for (var i = 0; i < lines.length; i++) {
                            var line = lines[i];
                            if (line.indexOf('data: ') === 0) {
                                try {
                                    var jsonData = JSON.parse(line.substring(6));
                                    if (jsonData.type === 'content_block_delta') {
                                        fullResponse += jsonData.delta.text;
                                        var safeText = fullResponse.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                                        assistantMessageElem.innerHTML = "Assistant: " + safeText + "<span class='cursor'></span>";
                                        chatLog.scrollTop = chatLog.scrollHeight;
                                    }
                                } catch (e) {
                                    // Ignore malformed JSON chunks
                                }
                            }
                        }
                        
                        return readChunk();
                    });
                }
                
                return readChunk();
            })
            .then(function() {
                assistantMessageElem.innerHTML = "Assistant: " + fullResponse.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                activeChat.messages.push({ role: 'assistant', content: fullResponse });

                var calcRegex = /<calculate>([\s\S]*?)<\/calculate>/;
                var match = fullResponse.match(calcRegex);
                if (match && match[1]) {
                    var expression = match[1];
                    var result = evaluateCalculation(expression);
                    var resultText = 'Result: ' + result;
                    displayMessage('tool', resultText);
                    activeChat.messages.push({ role: 'tool', content: resultText });
                }
            })
            .catch(function(error) {
                console.error(error);
                displayMessage('error', error.message);
            })
            .finally(function() {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send Message';
                saveData();
            });
        }
        
        newChatBtn.addEventListener('click', function() { 
            createNewChat(); 
        });
        
        chatList.addEventListener('click', function(event) { 
            if (event.target.tagName === 'LI') { 
                switchChat(event.target.getAttribute('data-chat-id')); 
            } 
        });
        
        sendBtn.addEventListener('click', getClaudeResponse);
        
        messageInput.addEventListener('keydown', function(event) { 
            if (event.key === 'Enter' && !event.shiftKey) { 
                event.preventDefault(); 
                getClaudeResponse(); 
            } 
        });

        loadData();
    });
